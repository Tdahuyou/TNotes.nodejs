# [0046. å…¨å±€å®šæ—¶å™¨ï¼šsetTimeoutã€setIntervalã€setImmediate](https://github.com/Tdahuyou/TNotes.nodejs/tree/main/notes/0046.%20%E5%85%A8%E5%B1%80%E5%AE%9A%E6%97%B6%E5%99%A8%EF%BC%9AsetTimeout%E3%80%81setInterval%E3%80%81setImmediate)

<!-- region:toc -->

- [1. ğŸ“’ æ¦‚è¿°](#1--æ¦‚è¿°)
- [2. ğŸ’» demos.1 - `setTimeout(cb, ms)`ã€`clearTimeout(t)`](#2--demos1---settimeoutcb-mscleartimeoutt)
- [3. ğŸ’» demos.2 - `setInterval(cb, ms)`ã€`clearInterval(t)`](#3--demos2---setintervalcb-msclearintervalt)
- [4. ğŸ’» demos.3 - `setImmediate(callback[, ...args])`ã€`clearImmediate(immediate)`](#4--demos3---setimmediatecallback-argsclearimmediateimmediate)
- [5. ğŸ¤” `setTimeout(fn, 0)` å’Œ `setImmediate(fn)` ä¹‹é—´çš„åŒºåˆ«](#5--settimeoutfn-0-å’Œ-setimmediatefn-ä¹‹é—´çš„åŒºåˆ«)

<!-- endregion:toc -->

## 1. ğŸ“’ æ¦‚è¿°

| å‡½æ•° | è¯´æ˜ |
| --- | --- |
| `setTimeout(cb, ms)` | æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨æŒ‡å®šçš„æ¯«ç§’ï¼ˆmsï¼‰æ•°åæ‰§è¡ŒæŒ‡å®šå‡½æ•°ï¼ˆcbï¼‰ |
| `clearTimeout(t)` | å–æ¶ˆå®šæ—¶å™¨ï¼Œåœæ­¢ä¸€ä¸ªä¹‹å‰è°ƒç”¨ `setTimeout()` åˆ›å»ºçš„å®šæ—¶å™¨ |
| `setInterval(cb, ms)` | æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”ä¸€å®šçš„æ—¶é—´ï¼ˆmsï¼‰å°±æ‰§è¡Œä¸€æ¬¡å‡½æ•°ï¼ˆcbï¼‰ |
| `clearInterval(t)` | å–æ¶ˆå®šæ—¶å™¨ï¼Œåœæ­¢ä¹‹å‰è°ƒç”¨ `setInterval()` åˆ›å»ºçš„å®šæ—¶å™¨ |
| `setImmediate(callback[, ...args])` | å®‰æ’åœ¨ I/O äº‹ä»¶çš„å›è°ƒä¹‹åç«‹å³æ‰§è¡Œçš„ callback |
| `clearImmediate(immediate)` | å–æ¶ˆç”± `setImmediate()` åˆ›å»ºçš„ Immediate å¯¹è±¡ |

- **global.xxx**
  - è¿™äº›å‡½æ•°éƒ½æ˜¯ Node.js ä¸­çš„å…¨å±€å‡½æ•°ï¼Œå±äº **å…¨å±€å¯¹è±¡ï¼ˆ`global`ï¼‰** çš„ä¸€éƒ¨åˆ†ã€‚
  - è¿™æ„å‘³ç€ä½ æ— éœ€å¼•å…¥ä»»ä½•æ¨¡å—å³å¯ç›´æ¥ä½¿ç”¨å®ƒä»¬ã€‚
- **ä½œç”¨**ï¼š
  - ç”¨äºæ§åˆ¶å¼‚æ­¥æ“ä½œçš„æ‰§è¡Œæ—¶æœºã€‚
- **æ³¨æ„**ï¼š
  - **ä¸æµè§ˆå™¨ç¯å¢ƒçš„åŒºåˆ«**ï¼šè™½ç„¶ `setTimeout` å’Œ `setInterval` ä¹Ÿå­˜åœ¨äºæµè§ˆå™¨ä¸­ï¼Œä½† `setImmediate` æ˜¯ Node.js ç‰¹æœ‰çš„åŠŸèƒ½ã€‚

## 2. ğŸ’» demos.1 - `setTimeout(cb, ms)`ã€`clearTimeout(t)`

::: code-group

```javascript [1.js]
setTimeout(() => {
  console.log('1s åè¢«æ‰“å°')
}, 1000)

// setTimeout
// ä½œç”¨: è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨æŒ‡å®šçš„æ¯«ç§’æ•°ï¼ˆmsï¼‰åæ‰§è¡Œå›è°ƒå‡½æ•°ï¼ˆcbï¼‰ã€‚
```

```javascript [2.js]
const timer = setTimeout(() => {
  console.log('1s åè¢«æ‰“å°')
}, 1000)

// å¦‚æœéœ€è¦ï¼Œå¯ä»¥å–æ¶ˆå®šæ—¶å™¨
clearTimeout(timer)

// setTimeout
// è¿”å›å€¼: è¿”å›ä¸€ä¸ª Timeout å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥å–æ¶ˆå®šæ—¶å™¨ã€‚

// clearTimeout
// ä½œç”¨: å–æ¶ˆç”± setTimeout() åˆ›å»ºçš„å®šæ—¶å™¨ã€‚
// å‚æ•°: æ¥æ”¶ setTimeout() è¿”å›çš„ Timeout å¯¹è±¡ã€‚
```

:::

- **ä½¿ç”¨åœºæ™¯**ï¼šé€‚åˆéœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¾‹å¦‚å®šæ—¶ä»»åŠ¡ã€å®šæ—¶å™¨ç­‰ã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
  - å®šæ—¶å™¨çš„å®é™…è§¦å‘æ—¶é—´å¯èƒ½ä¼šå—åˆ°äº‹ä»¶å¾ªç¯è´Ÿè½½çš„å½±å“ï¼Œå› æ­¤ä¸èƒ½ä¿è¯å®Œå…¨ç²¾ç¡®ã€‚

## 3. ğŸ’» demos.2 - `setInterval(cb, ms)`ã€`clearInterval(t)`

::: code-group

```javascript [1.js]
setInterval(() => {
  console.log('æ¯éš” 1 ç§’æ‰“å°ä¸€æ¬¡')
}, 1000)

// setInterval
// ä½œç”¨: è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”ä¸€å®šçš„æ—¶é—´ï¼ˆms æ¯«ç§’ï¼‰é‡å¤æ‰§è¡Œå›è°ƒå‡½æ•°ï¼ˆcbï¼‰ã€‚
```

```javascript [2.js]
const interval = setInterval(() => {
  console.log('This will stop after 3 seconds')
}, 1000)

setTimeout(() => {
  console.log('å®šæ—¶å™¨å·²åœæ­¢')
  clearInterval(interval) // åœæ­¢å®šæ—¶å™¨
}, 3000)

// setInterval
// è¿”å›å€¼: è¿”å›ä¸€ä¸ª Timeout å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥å–æ¶ˆå®šæ—¶å™¨ã€‚

// clearInterval
// ä½œç”¨: å–æ¶ˆç”± setInterval() åˆ›å»ºçš„å®šæ—¶å™¨ã€‚
// å‚æ•°: æ¥æ”¶ setInterval() è¿”å›çš„ Timeout å¯¹è±¡ã€‚
```

```javascript [3.js]
let i = 0 // è®°å½•æ‰§è¡Œç¨‹åºçš„æ¬¡æ•°
const timer = setInterval(function () {
  i += 1
  console.log('å·²æ‰§è¡Œ' + i + 'æ¬¡')
  if (i >= 5) {
    clearInterval(timer) // æ‰§è¡Œ 5 æ¬¡åï¼Œå–æ¶ˆå®šæ—¶å™¨
    console.log('æ‰§è¡Œå®Œæ¯•')
  }
}, 2000)

// è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œæ¯éš”2ç§’ä¼šæ˜¾ç¤ºä¸€æ¬¡æ‰§è¡Œå‡½æ•°çš„æ¬¡æ•°ï¼Œç›´åˆ°æ‰§è¡Œ5æ¬¡ä»¥åï¼Œå–æ¶ˆå®šæ—¶å™¨ï¼Œæœ€ç»ˆè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
// å·²æ‰§è¡Œ1æ¬¡
// å·²æ‰§è¡Œ2æ¬¡
// å·²æ‰§è¡Œ3æ¬¡
// å·²æ‰§è¡Œ4æ¬¡
// å·²æ‰§è¡Œ5æ¬¡
// æ‰§è¡Œå®Œæ¯•
```

:::

- **ä½¿ç”¨åœºæ™¯**: é€‚åˆéœ€è¦å‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¾‹å¦‚è½®è¯¢ã€åŠ¨ç”»å¸§æ›´æ–°ç­‰ã€‚
- **æ³¨æ„äº‹é¡¹**:
  - å¦‚æœæœªæ­£ç¡®è°ƒç”¨ `clearInterval()`ï¼Œå®šæ—¶å™¨ä¼šä¸€ç›´è¿è¡Œï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚
  - å®šæ—¶å™¨çš„å®é™…è§¦å‘æ—¶é—´å¯èƒ½ä¼šå—åˆ°äº‹ä»¶å¾ªç¯è´Ÿè½½çš„å½±å“ï¼Œå› æ­¤ä¸èƒ½ä¿è¯å®Œå…¨ç²¾ç¡®ã€‚

## 4. ğŸ’» demos.3 - `setImmediate(callback[, ...args])`ã€`clearImmediate(immediate)`

::: code-group

```javascript [1.js]
setImmediate(() => {
  console.log('This runs immediately after I/O events')
})

// setImmediate
// ä½œç”¨: å°†å›è°ƒå‡½æ•°å®‰æ’åœ¨å½“å‰äº‹ä»¶å¾ªç¯çš„æœ«å°¾ã€I/O äº‹ä»¶å¤„ç†å®Œæˆä¹‹åç«‹å³æ‰§è¡Œã€‚
// ç”¨é€”: é€‚åˆç”¨äºå»¶è¿Ÿæ‰§è¡ŒæŸäº›é€»è¾‘ï¼Œè€Œä¸é˜»å¡ I/O æ“ä½œã€‚
```

```javascript [2.js]
const immediate = setImmediate(() => {
  console.log('This will not run')
})

clearImmediate(immediate) // ç«‹å³å–æ¶ˆ

// clearImmediate
// ä½œç”¨: å–æ¶ˆç”± setImmediate() åˆ›å»ºçš„ Immediate å¯¹è±¡ã€‚
// å‚æ•°: æ¥æ”¶ setImmediate() è¿”å›çš„ Immediate å¯¹è±¡ã€‚
```

```javascript [3.js]
console.log('æ­£å¸¸æ‰§è¡Œ1')
const t = setImmediate(function () {
  console.log('æˆ‘è¢«å»¶è¿Ÿæ‰§è¡Œäº†')
})
console.log('æ­£å¸¸æ‰§è¡Œ2')
// clearImmediate(t)

// ä¸Šé¢ä»£ç çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š
// æ­£å¸¸æ‰§è¡Œ1
// æ­£å¸¸æ‰§è¡Œ2
// æˆ‘è¢«å»¶è¿Ÿæ‰§è¡Œäº†

// å¦‚æœå°†æœ€åä¸€è¡Œä»£ç  clearImmediate(t) å–æ¶ˆæ³¨é‡Šï¼Œåˆ™è¿è¡Œç»“æœå¦‚ä¸‹ï¼š
// æ­£å¸¸æ‰§è¡Œ1
// æ­£å¸¸æ‰§è¡Œ2

// åŸå› åˆ†æï¼š

// ã€1ã€‘
// function () {
//   console.log('æˆ‘è¢«å»¶è¿Ÿæ‰§è¡Œäº†')
// }
// setImmediate ä¸­çš„è¿™ä¸ª function ä¼šè¢«æ¨å…¥äº‹ä»¶å¾ªç¯çš„ Check é˜¶æ®µï¼Œåœ¨åŒæ­¥ä»£ç æ‰§è¡Œå®Œåè¿è¡Œã€‚

// ã€2ã€‘
// clearImmediate(t)
// è¿™æ˜¯åŒæ­¥ä»£ç ï¼Œä¼šå…ˆäºå¼‚æ­¥ä»£ç ã€1ã€‘è¢«æ‰§è¡Œã€‚
```

:::

- **ç‰¹ç‚¹**ï¼š
  - `setImmediate` æ˜¯ Node.js ç‰¹æœ‰çš„åŠŸèƒ½ï¼Œåœ¨æµè§ˆå™¨ä¸­ä¸å¯ç”¨ã€‚
  - å®ƒé€šå¸¸ä¼šä¼˜å…ˆäº `setTimeout(fn, 0)` è¢«æ‰§è¡Œï¼Œå› ä¸ºå®ƒä¼šè¢«æ¨é€åˆ° check é˜¶æ®µï¼ŒI/O æ“ä½œç»“æŸåï¼Œå°±ä¼šç«‹å³æ‰§è¡Œã€‚
- **ä½¿ç”¨åœºæ™¯**ï¼šå»¶è¿ŸæŸäº›æ“ä½œåˆ°å½“å‰äº‹ä»¶å¾ªç¯çš„æœ«å°¾ï¼Œé¿å…é˜»å¡ I/O æ“ä½œã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
  - ä¸è¦æ»¥ç”¨ `setImmediate`ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¯¼è‡´å›è°ƒå †ç§¯ï¼Œå½±å“æ€§èƒ½ã€‚
  - å¦‚æœéœ€è¦å–æ¶ˆï¼Œè¯·åŠæ—¶è°ƒç”¨ `clearImmediate()`ã€‚

## 5. ğŸ¤” `setTimeout(fn, 0)` å’Œ `setImmediate(fn)` ä¹‹é—´çš„åŒºåˆ«

::: tip å¤‡æ³¨

- è¿™æ˜¯ä¸€ä¸ªå…³äºâ€œNode.js ç”Ÿå‘½å‘¨æœŸã€äº‹ä»¶å¾ªç¯â€çš„ç»å…¸é¢è¯•é¢˜ã€‚
- æœ‰å…³ Node.js ç”Ÿå‘½å‘¨æœŸã€äº‹ä»¶å¾ªç¯çš„ç›¸å…³å†…å®¹ï¼Œå¯ä»¥å‚è€ƒ `TNotes.nodejs.0050` ç¬”è®°ã€‚

:::

| ç‰¹æ€§         | `setTimeout(fn, 0)`  | `setImmediate(fn)`    |
| ------------ | -------------------- | --------------------- |
| **è°ƒåº¦é˜¶æ®µ** | Timer é˜¶æ®µ           | Check é˜¶æ®µ            |
| **å»¶è¿Ÿç²¾åº¦** | é€šå¸¸ > 0ms           | æ— å»¶è¿Ÿï¼Œç«‹å³æ‰§è¡Œ      |
| **ä½¿ç”¨åœºæ™¯** | æ¨è¿Ÿåˆ°ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ | åœ¨ I/O å®Œæˆåç«‹å³æ‰§è¡Œ |

- **ğŸ¤” å“ªä¸ªä¼šå…ˆè¢«æ‰§è¡Œï¼Ÿ**
  - å¾—çœ‹å…·ä½“æƒ…å†µï¼Œé€šå¸¸æ˜¯ setImmediate å…ˆã€‚
  - **è°ƒåº¦é˜¶æ®µçš„å·®å¼‚**
    - Node.js çš„äº‹ä»¶å¾ªç¯åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µè´Ÿè´£å¤„ç†ç‰¹å®šçš„ä»»åŠ¡ã€‚
  - **Timer é˜¶æ®µ**ï¼š
    - å¤„ç†ç”± `setTimeout` å’Œ `setInterval` è®¾ç½®çš„å®šæ—¶å™¨å›è°ƒã€‚
    - å½“å‰æ—¶é—´è¾¾åˆ°æˆ–è¶…è¿‡å®šæ—¶å™¨è®¾å®šçš„æ—¶é—´æ—¶ï¼Œå›è°ƒä¼šè¢«æ¨å…¥ Timer é˜¶æ®µçš„é˜Ÿåˆ—ä¸­ã€‚
  - **Check é˜¶æ®µ**ï¼š
    - å¤„ç†ç”± `setImmediate` è®¾ç½®çš„å›è°ƒã€‚
    - `setImmediate` çš„å›è°ƒæ€»æ˜¯è¢«æ¨å…¥ Check é˜¶æ®µçš„é˜Ÿåˆ—ä¸­ã€‚
  - å› æ­¤ï¼Œ`setTimeout(fn, 0)` å’Œ `setImmediate(fn)` çš„æ‰§è¡Œé¡ºåºå–å†³äºå½“å‰äº‹ä»¶å¾ªç¯æ‰€å¤„çš„é˜¶æ®µã€‚
- **ğŸ¤” å»¶è¿Ÿç²¾åº¦å“ªä¸ªæ›´å‡†ï¼Ÿ**
  - `setImmediate` æ›´å‡†ï¼Œå®ƒç›¸å½“äºæ²¡æœ‰å»¶è¿Ÿï¼Œå°±æ˜¯ 0msï¼›è€Œ `setTimeout(fn, 0)` å®é™…çš„å»¶è¿Ÿæ—¶é—´ä¼šå¤§äº 0msã€‚
  - **`setTimeout(fn, 0)`**ï¼š
    - å³ä½¿è®¾ç½®ä¸º `0ms`ï¼Œå®é™…å»¶è¿Ÿé€šå¸¸ä¼šå¤§äº `0ms`ï¼Œå› ä¸º Timer é˜¶æ®µéœ€è¦ç­‰å¾…äº‹ä»¶å¾ªç¯åˆ°è¾¾è¯¥é˜¶æ®µã€‚
    - æ ¹æ®ç¯å¢ƒä¸åŒï¼Œå»¶è¿Ÿå…·ä½“æ—¶é—´ä¼šæœ‰è¾ƒå¤§å·®å¼‚ã€‚
  - **`setImmediate(fn)`**ï¼š
    - æ²¡æœ‰å»¶è¿Ÿæ—¶é—´çš„æ¦‚å¿µï¼Œå®ƒä¼šåœ¨å½“å‰äº‹ä»¶å¾ªç¯çš„ I/O é˜¶æ®µç»“æŸåç«‹å³æ‰§è¡Œã€‚
    - å› æ­¤ï¼Œ`setImmediate` çš„æ‰§è¡Œé€Ÿåº¦é€šå¸¸æ¯” `setTimeout(fn, 0)` æ›´å¿«ã€‚
- **ğŸ¤” ä»€ä¹ˆæ—¶å€™ç”¨ `setTimeout(fn, 0)`ï¼Œä»€ä¹ˆæ—¶å€™ç”¨ `setImmediate(fn)`ï¼Ÿ**
  - **`setTimeout(fn, 0)`**ï¼š
    - é€‚åˆéœ€è¦å°½å¯èƒ½çŸ­çš„å»¶è¿Ÿï¼Œä½†åˆä¸å¸Œæœ›é˜»å¡å½“å‰äº‹ä»¶å¾ªç¯çš„æƒ…å†µã€‚
    - å¸¸ç”¨äºå°†ä»»åŠ¡æ¨è¿Ÿåˆ°ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯è¿­ä»£ã€‚
  - **`setImmediate(fn)`**ï¼š
    - é€‚åˆéœ€è¦åœ¨ I/O æ“ä½œå®Œæˆåç«‹å³æ‰§è¡ŒæŸäº›é€»è¾‘çš„åœºæ™¯ã€‚
    - å¸¸ç”¨äºé¿å…é˜»å¡ I/O æ“ä½œï¼Œæˆ–è€…åœ¨å¼‚æ­¥æµç¨‹ä¸­æ’å…¥é¢å¤–çš„é€»è¾‘ã€‚
