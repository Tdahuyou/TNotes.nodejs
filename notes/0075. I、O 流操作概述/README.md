# [0075. Iã€O æµæ“ä½œæ¦‚è¿°](https://github.com/Tdahuyou/TNotes.nodejs/tree/main/notes/0075.%20I%E3%80%81O%20%E6%B5%81%E6%93%8D%E4%BD%9C%E6%A6%82%E8%BF%B0)

<!-- region:toc -->

- [1. ğŸ“ æ¦‚è¿°](#1--æ¦‚è¿°)
- [2. ğŸ“’ å¯è¯»æµï¼ˆReadable Streamï¼‰](#2--å¯è¯»æµreadable-stream)
- [3. ğŸ“’ å¯å†™æµï¼ˆWritable Streamï¼‰](#3--å¯å†™æµwritable-stream)
- [4. ğŸ“’ åŒå·¥æµï¼ˆDuplex Streamï¼‰](#4--åŒå·¥æµduplex-stream)
- [5. ğŸ“’ è½¬æ¢æµï¼ˆTransform Streamï¼‰](#5--è½¬æ¢æµtransform-stream)

<!-- endregion:toc -->

## 1. ğŸ“ æ¦‚è¿°

- **æµ**ï¼š
  - æµæŒ‡çš„æ˜¯æ•°æ®çš„æµåŠ¨ã€‚
  - ç¨‹åºä¸­çš„æµæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå½“ç¨‹åºéœ€è¦ä»æŸä¸ªæ•°æ®æºè¯»å–æ•°æ®æ—¶ï¼Œå°±ä¼šå¼€å¯ä¸€ä¸ªæ•°æ®æµï¼Œæ•°æ®æºå¯ä»¥æ˜¯æ–‡ä»¶ã€å†…å­˜æˆ–è€…ç½‘ç»œç­‰ï¼Œè€Œå½“ç¨‹åºå°†æ•°æ®å†™å…¥æŸä¸ªæ•°æ®æºæ—¶ï¼Œä¹Ÿä¼šå¼€å¯ä¸€ä¸ªæ•°æ®æµï¼Œè€Œæ•°æ®æºçš„ç›®çš„åœ°ä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶ã€å†…å­˜æˆ–è€…ç½‘ç»œç­‰ã€‚
  - ä»¥æ–‡ä»¶æµä¸ºä¾‹ï¼Œå½“éœ€è¦è¯»å–ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå¦‚æœä½¿ç”¨ fs æ¨¡å—çš„ `readFile()` æ–¹æ³•è¯»å–ï¼Œç¨‹åºä¼šå°†è¯¥æ–‡ä»¶çš„å†…å®¹è§†ä¸ºä¸€ä¸ªæ•´ä½“ï¼Œä¸ºå…¶åˆ†é…ç¼“å­˜åŒºå¹¶ä¸€æ¬¡æ€§å°†å†…å®¹è¯»å–åˆ°ç¼“å­˜åŒºä¸­ï¼Œåœ¨è¿™æœŸé—´ï¼ŒNode.js å°†ä¸èƒ½æ‰§è¡Œä»»ä½•å…¶ä»–å¤„ç†ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå³å¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œä¼šè€—è´¹è¾ƒå¤šçš„æ—¶é—´ã€‚
  - æµæ˜¯ Node.js ä¸­ç”¨äºå¤„ç†æ•°æ®çš„ä¸€ç§é«˜æ•ˆæœºåˆ¶ï¼Œé€‚ç”¨äº **å¤„ç†å¤§è§„æ¨¡æ•°æ®æˆ–æŒç»­çš„æ•°æ®æµ**ã€‚
  - **æµçš„æ ¸å¿ƒæ€æƒ³**ï¼š
    - æµçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ•°æ®åˆ†æˆå°å—è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ•°æ®é›†ï¼Œä»è€ŒèŠ‚çœå†…å­˜å¹¶æé«˜æ€§èƒ½ã€‚
    - æ¯”å¦‚ï¼Œä½¿ç”¨æ–‡ä»¶æµè¯»å–æ–‡ä»¶ï¼Œå¯ä»¥å°†æ–‡ä»¶ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†åœ°è¯»å–ï¼Œè¿™æ ·åšå¯ä»¥ä¿è¯æ•ˆç‡ï¼Œå¹¶ä¸”ä¸ä¼šå ç”¨å¤ªå¤§çš„å†…å­˜ã€‚
  - **æµçš„å…³é”®çŸ¥è¯†ç‚¹**ï¼š
    - ç†è§£æµçš„æ¨¡å¼ã€çŠ¶æ€ã€äº‹ä»¶ä»¥åŠå¸¸ç”¨æ“ä½œæ˜¯æŒæ¡æµæŠ€æœ¯çš„å…³é”®ã€‚
- **æµçš„åŸºæœ¬ç±»å‹**ï¼š
  - **å¯è¯»æµï¼ˆReadable Streamï¼‰**ï¼šç”¨äºä»æ•°æ®æºè¯»å–æ•°æ®ã€‚
  - **å¯å†™æµï¼ˆWritable Streamï¼‰**ï¼šç”¨äºå‘ç›®æ ‡å†™å…¥æ•°æ®ã€‚
  - **åŒå·¥æµï¼ˆDuplex Streamï¼‰**ï¼šåŒæ—¶æ”¯æŒè¯»å–å’Œå†™å…¥æ“ä½œï¼Œä¹Ÿç§°ä¸ºå¯è¯»å¯å†™æµã€‚
  - **è½¬æ¢æµï¼ˆTransform Streamï¼‰**ï¼šè¡¨ç¤ºåœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ `Duplex` æµã€‚
  - å°ç»“ï¼šå¯è¯»æµç”¨äºè¯»å–æ•°æ®ï¼Œå¯å†™æµç”¨äºå†™å…¥æ•°æ®ï¼ŒåŒå·¥æµå’Œè½¬æ¢æµåˆ™æä¾›äº†æ›´å¤æ‚çš„äº¤äº’èƒ½åŠ›ã€‚
- **Buffer**ï¼š
  - Buffer ç¿»è¯‘ä¸ºä¸­æ–‡æ˜¯ç¼“å†²åŒºï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼š**ä¸€ä¸ª Buffer å°±æ˜¯å¼€è¾Ÿçš„ä¸€å—å†…å­˜åŒºåŸŸï¼ŒBuffer çš„å¤§å°å°±æ˜¯å¼€è¾Ÿçš„å†…å­˜åŒºåŸŸçš„å¤§å°**ã€‚
  - åœ¨æµä¸­ï¼ŒBuffer çš„å¤§å°å–å†³äºä¼ å…¥æµæ„é€ å‡½æ•°çš„ highWaterMark é€‰é¡¹å‚æ•°ï¼Œè¯¥å‚æ•°æŒ‡å®šäº†å­—èŠ‚æ€»æ•°æˆ–è€…å¯¹è±¡æ€»æ•°ï¼Œå½“å¯è¯»ç¼“å†²åŒºçš„æ€»å¤§å°è¾¾åˆ° highWaterMark æŒ‡å®šçš„é˜ˆå€¼æ—¶ï¼Œæµä¼šæš‚æ—¶åœæ­¢ä»æ•°æ®æºè¯»å–æ•°æ®ï¼Œç›´åˆ°å½“å‰ç¼“å†²åŒºçš„æ•°æ®è¢«é‡Šæ”¾ï¼›å¦‚æœè¦è·å–ç¼“å†²åŒºä¸­å­˜å‚¨çš„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨ `writable.writableBuffer` æˆ– `readable.readableBuffer`ã€‚
  - Buffer æ˜¯ Node.js ä¸­ç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„å·¥å…·ã€‚
  - æµé€šå¸¸ä»¥ Buffer çš„å½¢å¼ä¼ é€’æ•°æ®ï¼Œå› æ­¤ç†è§£ Buffer å¯¹äºæµçš„æ“ä½œè‡³å…³é‡è¦ã€‚

## 2. ğŸ“’ å¯è¯»æµï¼ˆReadable Streamï¼‰

- **å¯è¯»æµçš„è¯»å–æ¨¡å¼**ï¼š
  - **æµåŠ¨æ¨¡å¼ï¼ˆFlowing Modeï¼‰**ï¼šæ•°æ®è‡ªåŠ¨æµå‘äº‹ä»¶ç›‘å¬å™¨ã€‚
    - æµåŠ¨æ¨¡å¼æŒ‡çš„æ˜¯ä¸€æ—¦å¼€å§‹è¯»å–æ–‡ä»¶ï¼Œä¼šæŒ‰ç…§ `highWaterMark` çš„å€¼æŒ‰æ¬¡è¯»å–ï¼Œç›´åˆ°è¯»å–å®Œä¸ºæ­¢ã€‚
    - å½“æµå¤„äºæµåŠ¨æ¨¡å¼æ—¶ï¼Œå› ä¸ºæ•°æ®æ˜¯æŒç»­å˜åŒ–çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ç›‘å¬äº‹ä»¶æ¥å¤„ç†å®ƒã€‚
  - **æš‚åœæ¨¡å¼ï¼ˆPaused Modeï¼‰**ï¼šéœ€è¦æ‰‹åŠ¨è°ƒç”¨ `read()` æ–¹æ³•è¯»å–æ•°æ®ã€‚
    - æ‰€æœ‰çš„å¯è¯»æµéƒ½æ˜¯ä»¥æš‚åœæ¨¡å¼å¼€å§‹ï¼Œå½“æµå¤„äºæš‚åœæ¨¡å¼æ—¶ï¼Œå¯ä»¥é€šè¿‡ `read()` æ–¹æ³•ä»æµä¸­æŒ‰éœ€è¯»å–æ•°æ®ã€‚
- **æ¨¡å¼åˆ‡æ¢**ï¼š
  - æµçš„æš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼æ˜¯å¯ä»¥äº’ç›¸åˆ‡æ¢çš„ã€‚
  - **Paused -> Flowing**ï¼šé€šè¿‡æ·»åŠ  `data` äº‹ä»¶ã€ä½¿ç”¨ `resume()` æ–¹æ³•æˆ–è€… `pipe()` æ–¹æ³•ç­‰éƒ½å¯ä»¥å°†å¯è¯»æµä»æš‚åœæ¨¡å¼åˆ‡æ¢ä¸ºæµåŠ¨æ¨¡å¼ã€‚
  - **Flowing -> Paused**ï¼šä½¿ç”¨ `paused()` æ–¹æ³•æˆ–è€… `unpipe()` æ–¹æ³•å¯ä»¥å°†å¯è¯»æµä»æµåŠ¨æ¨¡å¼åˆ‡æ¢ä¸ºæš‚åœæ¨¡å¼ã€‚
- **å¯è¯»æµçš„çŠ¶æ€**ï¼š
  - **åˆå§‹çŠ¶æ€**ï¼šæµå·²åˆ›å»ºä½†å°šæœªå¼€å§‹è¯»å–ã€‚
  - **æµåŠ¨çŠ¶æ€**ï¼šæ•°æ®æ­£åœ¨æµå‘äº‹ä»¶ç›‘å¬å™¨ã€‚
  - **æš‚åœçŠ¶æ€**ï¼šæµå·²æš‚åœï¼Œç­‰å¾…è¿›ä¸€æ­¥æ“ä½œã€‚
  - **ç»“æŸçŠ¶æ€**ï¼šæµå·²è¯»å–å®Œæ¯•ï¼Œæ²¡æœ‰æ›´å¤šæ•°æ®ã€‚
  - å¤‡æ³¨ï¼š
    - åœ¨å®é™…ä½¿ç”¨å¯è¯»æµæ—¶ï¼Œå®ƒä¸€å…±æœ‰ 3 ç§çŠ¶æ€ï¼Œå³åˆå§‹çŠ¶æ€ `null`ã€æµåŠ¨çŠ¶æ€ `true` å’ŒéæµåŠ¨çŠ¶æ€ `false`ã€‚
      - ä¸Šè¿°æåˆ°çš„ã€æš‚åœçŠ¶æ€ã€‘å’Œã€ç»“æŸçŠ¶æ€ã€‘è¡¨ç¤ºçš„æ˜¯æµçš„ã€éæµåŠ¨çŠ¶æ€ã€‘ã€‚
    - å½“æµå¤„äºåˆå§‹çŠ¶æ€ `null` æ—¶ï¼Œç”±äºæ²¡æœ‰æ•°æ®ä½¿ç”¨è€…ï¼Œæ‰€ä»¥æµä¸ä¼šäº§ç”Ÿæ•°æ®ï¼Œè¿™æ—¶å¦‚æœç›‘å¬ `data` äº‹ä»¶ã€è°ƒç”¨ `pipe()` æ–¹æ³•æˆ– `resume()` æ–¹æ³•ï¼Œéƒ½ä¼šå°†å½“å‰çŠ¶æ€åˆ‡æ¢ä¸ºæµåŠ¨çŠ¶æ€ `true`ï¼Œè¿™æ ·å¯è¯»æµå³å¯å¼€å§‹ä¸»åŠ¨åœ°äº§ç”Ÿæ•°æ®å¹¶è§¦å‘äº‹ä»¶ã€‚
    - å¦‚æœè°ƒç”¨ `pause()` æ–¹æ³•æˆ–è€… `unpipe()` æ–¹æ³•ï¼Œå°±ä¼šå°†å¯è¯»æµçš„çŠ¶æ€åˆ‡æ¢ä¸ºéæµåŠ¨çŠ¶æ€ `false`ï¼Œè¿™å°†æš‚åœæµï¼Œä½†ä¸ä¼šæš‚åœæ•°æ®ç”Ÿæˆã€‚
      - æ­¤æ—¶ï¼Œå¦‚æœå†ä¸º `data` äº‹ä»¶è®¾ç½®ç›‘å¬å™¨ï¼Œå°±ä¸ä¼šå†å°†çŠ¶æ€åˆ‡æ¢ä¸ºæµåŠ¨çŠ¶æ€ `true` äº†ã€‚
- å¯è¯»æµå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼åˆ›å»ºï¼Œä¾‹å¦‚ï¼š
  - ä½¿ç”¨ `fs.createReadStream(path[, options])` åˆ›å»ºæ–‡ä»¶æµã€‚
  - ä½¿ç”¨ `net.Socket` åˆ›å»ºç½‘ç»œæµã€‚
  - é£Ÿç”¨ stream æ¨¡å—ä¸­çš„ Readable ç±»è¡¨ç¤º `new stream.Readable()`ã€‚
- API `fs.createReadStream(path[, options])` çš„è¯¦ç»†è¯´æ˜ï¼š
  - path è¡¨ç¤ºè¯»å–æ–‡ä»¶çš„æ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€ç¼“å†²åŒºæˆ–ç½‘å€ã€‚
  - options è¯»å–æ–‡ä»¶æ—¶çš„å¯é€‰å‚æ•°ï¼Œå¸¸ç”¨é…ç½®å¦‚ä¸‹ï¼š
    - `flags`ï¼šæŒ‡å®šæ–‡ä»¶ç³»ç»Ÿçš„æƒé™ï¼Œé»˜è®¤ä¸º rã€‚
    - `encoding`ï¼šç¼–ç æ–¹å¼ï¼Œé»˜è®¤ä¸º nullã€‚
    - `fd`ï¼šæ–‡ä»¶æè¿°ç¬¦ï¼Œé»˜è®¤ä¸º nullã€‚
    - `mode`ï¼šè®¾ç½®æ–‡ä»¶æ¨¡å¼ï¼Œé»˜è®¤ä¸º 0o666ã€‚
    - `autoClose`ï¼šæ–‡ä»¶å‡ºé”™æˆ–è€…ç»“æŸæ—¶ï¼Œæ˜¯å¦è‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼Œé»˜è®¤ä¸º trueã€‚
    - `emitClose`ï¼šæµé”€æ¯æ—¶ï¼Œæ˜¯å¦å‘é€ close äº‹ä»¶ï¼Œé»˜è®¤ä¸º trueã€‚
    - `start`ï¼šæŒ‡å®šå¼€å§‹è¯»å–çš„ä½ç½®ã€‚
    - `end`ï¼šæŒ‡å®šç»“æŸè¯»å–çš„ä½ç½®ã€‚
    - `highWaterMark`ï¼šå¯è¯»å–çš„é˜ˆå€¼ï¼Œä¸€èˆ¬è®¾ç½®åœ¨ 16 ï½ 100KB èŒƒå›´å†…ã€‚
- **å¯è¯»æµçš„å±æ€§ã€æ–¹æ³•åŠäº‹ä»¶**ï¼š

| å±æ€§ | è¯´æ˜ |
| --- | --- |
| `destroyed` | å¯è¯»æµæ˜¯å¦å·²é”€æ¯ï¼Œå¦‚æœå·²ç»è°ƒç”¨äº† `readable.destroy()` æ–¹æ³•ï¼Œåˆ™è¯¥å±æ€§å€¼ä¸º `true` |
| `readable` | å¯è¯»æµæ˜¯å¦è¢«ç ´åã€ç»“æŸæˆ–è€…æŠ¥é”™ |
| `readableEncoding` | è·å–å¯è¯»æµçš„ `encoding` å±æ€§ |
| `readableEnded` | å¯è¯»æµæ˜¯å¦å·²ç»æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœè§¦å‘äº† `end` äº‹ä»¶ï¼Œåˆ™è¯¥å±æ€§å€¼ä¸º `true` |
| `readableFlowing` | å¯è¯»æµçš„å½“å‰çŠ¶æ€ |
| `readableHighWaterMark` | æ„é€ å¯è¯»æµæ—¶ä¼ å…¥çš„ `highWaterMark` çš„å€¼ |
| `readableLength` | è·å–å‡†å¤‡è¯»å–çš„é˜Ÿåˆ—ä¸­çš„å­—èŠ‚æ•°ï¼ˆæˆ–å¯¹è±¡æ•°ï¼‰ |

| æ–¹æ³• | è¯´æ˜ |
| --- | --- |
| `read([size])` | ä»æµä¸­è¯»å–æ•°æ® |
| `setEncoding(encoding)` | è®¾ç½®ä»æµä¸­è¯»å–çš„æ•°æ®æ‰€ä½¿ç”¨çš„ç¼–ç  |
| `pause()` | æš‚åœä»å¯è¯»æµå¯¹è±¡å‘å‡ºçš„ `data` äº‹ä»¶ |
| `ispaused()` | è·å–å¯è¯»æµçš„å½“å‰æ“ä½œçŠ¶æ€ |
| `destroy()` | é”€æ¯å¯è¯»æµ |
| `resume()` | æ¢å¤ä»å¯è¯»æµå¯¹è±¡å‘å‡ºçš„ `data` äº‹ä»¶ |
| `pipe(destination[, options])` | æŠŠå¯è¯»æµçš„è¾“å‡ºä¼ è¾“åˆ°ä¸€ä¸ªç”± `destination` å‚æ•°æŒ‡å®šçš„ `Writable` æµå¯¹è±¡ |
| `unpipe([destination])` | åˆ†ç¦»é™„åŠ çš„ `Writable` æµå¯¹è±¡ |
| `filter(fn[, options])` | ç­›é€‰æµ |
| `forEach(fn[, options])` | è¿­ä»£éå†æµ |

| äº‹ä»¶ | è¯´æ˜ |
| --- | --- |
| `close` | å½“æµæˆ–å…¶æ•°æ®æºè¢«å…³é—­æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶ |
| `data` | åœ¨æµå°†æ•°æ®å—ä¼ é€ç»™ä½¿ç”¨è€…åè§¦å‘ |
| `end` | å½“æµä¸­æ²¡æœ‰æ•°æ®å¯ä¾›ä½¿ç”¨æ—¶è§¦å‘ |
| `error` | å½“æµç”±äºåº•å±‚å†…éƒ¨æ•…éšœè€Œæ— æ³•ç”Ÿæˆæ•°æ®æˆ–å°è¯•æ¨é€æ— æ•ˆæ•°æ®å—æ—¶è§¦å‘ |
| `pause` | å½“è°ƒç”¨ `stream.pause()` ä¸” `readableFlowing` ä¸ä¸º `false` æ—¶è§¦å‘ |
| `readable` | å½“æœ‰æ•°æ®å¯ä»æµä¸­è¯»å–æ—¶è§¦å‘ |
| `resume` | å½“è°ƒç”¨ `stream.resume()` ä¸” `readableFlowing` ä¸ä¸º `true` æ—¶è§¦å‘ |

- **å¯è¯»æµçš„å¸¸è§æ“ä½œ**ï¼š

```javascript
// è¯»å–æ•°æ®
const fs = require('fs')
const readable = fs.createReadStream('example.txt')

readable.on('data', (chunk) => {
  console.log(`Received chunk: ${chunk}`)
})

readable.on('end', () => {
  console.log('Stream ended')
})
```

```javascript
// è®¾ç½®ç¼–ç æ ¼å¼
const readable = fs.createReadStream(
  'example.txt',
  { encoding: 'utf8' } // å¦‚æœå¸Œæœ›å°† Buffer æ•°æ®è§£æä¸ºå­—ç¬¦ä¸²ï¼Œå¯ä»¥è®¾ç½®ç¼–ç æ ¼å¼ã€‚
)
```

```javascript
// æš‚åœä¸æ¢å¤æµ
readable.pause() // æš‚åœæµ
readable.resume() // æ¢å¤æµ
```

```javascript
// è·å–æµçš„è¿è¡ŒçŠ¶æ€
console.log(readable.readable) // æ˜¯å¦å¯è¯»
console.log(readable.paused) // æ˜¯å¦æš‚åœ
```

```javascript
// é”€æ¯æµ
readable.destroy() // é”€æ¯æµ
```

```javascript
// ç»‘å®šå¯å†™æµè‡³å¯è¯»æµ
const writable = fs.createWriteStream('output.txt')
readable.pipe(writable) // ä½¿ç”¨ pipe() æ–¹æ³•å°†å¯è¯»æµçš„æ•°æ®ä¼ è¾“åˆ°å¯å†™æµ
// ç›¸å½“äºå°†ä¸¤ä¸ªç®¡é“è¿æ¥èµ·æ¥ï¼Œå®ç°æ•°æ®çš„ä¼ è¾“ã€‚
```

```javascript
// è§£ç»‘å¯å†™æµ
readable.unpipe(writable)
// ä½¿ç”¨ unpipe() æ–¹æ³•è§£é™¤ç»‘å®š
// ç›¸å½“äºå°†è¿æ¥åˆ‡æ¢ã€‚
```

## 3. ğŸ“’ å¯å†™æµï¼ˆWritable Streamï¼‰

- å¯å†™æµå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼åˆ›å»ºï¼Œä¾‹å¦‚ï¼š
  - ä½¿ç”¨ `fs.createWriteStream()` åˆ›å»ºæ–‡ä»¶æµã€‚
  - ä½¿ç”¨ `net.Socket` åˆ›å»ºç½‘ç»œæµã€‚
  - ä½¿ç”¨è‡ªå®šä¹‰æµç±»ç»§æ‰¿ `stream.Writable`ã€‚
- å¯å†™æµçš„å±æ€§ã€æ–¹æ³•åŠäº‹ä»¶ï¼š
  - **å±æ€§**ï¼š
    - `writable`ï¼šè¡¨ç¤ºæµæ˜¯å¦å¤„äºå¯å†™çŠ¶æ€ã€‚
  - **æ–¹æ³•**ï¼š
    - `write(data)`ï¼šå‘æµä¸­å†™å…¥æ•°æ®ã€‚
    - `end()`ï¼šç»“æŸæµçš„å†™å…¥ã€‚
    - `destroy()`ï¼šé”€æ¯æµã€‚
  - **äº‹ä»¶**ï¼š
    - `drain`ï¼šå½“å†™å…¥ç¼“å†²åŒºä¸ºç©ºæ—¶è§¦å‘ã€‚
    - `finish`ï¼šå½“æµç»“æŸå†™å…¥æ—¶è§¦å‘ã€‚
    - `error`ï¼šå½“å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
- **å¯å†™æµçš„å¸¸è§æ“ä½œ**ï¼š

```javascript
// å†™å…¥æ•°æ®
const fs = require('fs')
const writable = fs.createWriteStream('output.txt')

writable.write('Hello, ')
writable.write('World!')
```

```javascript
// è®¾ç½®ç¼–ç æ–¹å¼
const writable = fs.createWriteStream(
  'output.txt',
  { encoding: 'utf8' } // å¦‚æœå†™å…¥çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¯ä»¥æŒ‡å®šç¼–ç æ ¼å¼ä¸º utf8ã€‚
)
```

```javascript
// å…³é—­æµ
writable.end()
```

```javascript
// é”€æ¯æµ
writable.destroy()
```

```javascript
// å°†æ•°æ®ç¼“å†²åˆ°å†…å­˜
// å¯ä»¥ä½¿ç”¨ Buffer æˆ–å…¶ä»–ç¼“å­˜æœºåˆ¶å­˜å‚¨æ•°æ®ï¼Œç„¶åå†å†™å…¥æµã€‚
const buffer = Buffer.from('Hello, World!')

// è¾“å‡ºç¼“å†²åçš„æ•°æ®
// åœ¨å†™å…¥æµä¹‹å‰ï¼Œå¯ä»¥å…ˆå°†æ•°æ®å­˜å‚¨åˆ°ç¼“å†²åŒºï¼Œç„¶åä¸€æ¬¡æ€§å†™å…¥ã€‚
writable.write(buffer)
```

## 4. ğŸ“’ åŒå·¥æµï¼ˆDuplex Streamï¼‰

- åŒå·¥æµåŒæ—¶æ”¯æŒè¯»å–å’Œå†™å…¥æ“ä½œï¼Œä¾‹å¦‚ `net.Socket` å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„åŒå·¥æµã€‚
- å®ƒå…è®¸åœ¨åŒä¸€ä¸ªæµä¸Šè¿›è¡ŒåŒå‘é€šä¿¡ã€‚
- **åŒå·¥æµçš„å®šä¹‰**ï¼š
  - åŒå·¥æµæ˜¯åŒæ—¶æ”¯æŒè¯»å–å’Œå†™å…¥æ“ä½œçš„æµï¼Œç»§æ‰¿è‡ª `stream.Duplex` ç±»ã€‚
  - å®ƒç»“åˆäº†å¯è¯»æµå’Œå¯å†™æµçš„åŠŸèƒ½ï¼Œå…è®¸åœ¨åŒä¸€ä¸ªæµä¸Šè¿›è¡ŒåŒå‘é€šä¿¡ã€‚
- **åŒå·¥æµçš„ç‰¹ç‚¹**ï¼š
  - **ç‹¬ç«‹æ€§**ï¼šåŒå·¥æµçš„è¯»å–å’Œå†™å…¥æ“ä½œæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ä¾‹å¦‚ï¼Œä»ä¸€ä¸ªåŒå·¥æµä¸­è¯»å–çš„æ•°æ®å¯èƒ½ä¸å†™å…¥çš„æ•°æ®æ— å…³ã€‚
  - **çµæ´»æ€§**ï¼šåŒå·¥æµå¯ä»¥ç”¨äºå®ç°å¤æ‚çš„æ•°æ®å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚ç½‘ç»œé€šä¿¡ã€æ•°æ®è½¬å‘ç­‰ã€‚
- **åŒå·¥æµçš„åº”ç”¨åœºæ™¯**ï¼š
  - **ç½‘ç»œé€šä¿¡**ï¼š`net.Socket` æ˜¯ä¸€ä¸ªå…¸å‹çš„åŒå·¥æµï¼Œå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚
  - **æ•°æ®è½¬å‘**ï¼šä¾‹å¦‚ï¼Œä»ä¸€ä¸ªè¾“å…¥æµè¯»å–æ•°æ®å¹¶å°†å…¶è½¬å‘åˆ°å¦ä¸€ä¸ªè¾“å‡ºæµã€‚
  - **å®æ—¶æ•°æ®å¤„ç†**ï¼šä¾‹å¦‚ï¼Œåœ¨ WebSocket ä¸­å®ç°åŒå‘é€šä¿¡ã€‚
- **åŒå·¥æµçš„åˆ›å»º**ï¼š
  - å¯ä»¥é€šè¿‡ç»§æ‰¿ `stream.Duplex` ç±»æ¥åˆ›å»ºè‡ªå®šä¹‰çš„åŒå·¥æµã€‚

```javascript
const { Duplex } = require('stream')

class MyDuplexStream extends Duplex {
  constructor(options) {
    super(options)
    this.data = []
  }

  _read(size) {
    // ä»å†…éƒ¨ç¼“å†²åŒºè¯»å–æ•°æ®
    const chunk = this.data.shift()
    if (chunk !== undefined) {
      this.push(chunk) // å°†æ•°æ®æ¨é€åˆ°å¯è¯»æµ
    } else {
      this.push(null) // è¡¨ç¤ºæµç»“æŸ
    }
  }

  _write(chunk, encoding, callback) {
    // å°†æ•°æ®å†™å…¥å†…éƒ¨ç¼“å†²åŒº
    this.data.push(chunk)
    callback() // å†™å…¥å®Œæˆåçš„å›è°ƒ
  }
}

const duplexStream = new MyDuplexStream()

// å†™å…¥æ•°æ®
duplexStream.write('Hello')
duplexStream.write('World')

// è¯»å–æ•°æ®
duplexStream.on('data', (chunk) => {
  console.log(`Received: ${chunk.toString()}`)
})
```

- **åŒå·¥æµçš„å¸¸è§æ“ä½œ**ï¼š
  - **å†™å…¥æ•°æ®**ï¼šä½¿ç”¨ `write()` æ–¹æ³•å‘åŒå·¥æµå†™å…¥æ•°æ®ã€‚
  - **è¯»å–æ•°æ®**ï¼šç›‘å¬ `data` äº‹ä»¶æˆ–è°ƒç”¨ `read()` æ–¹æ³•è¯»å–æ•°æ®ã€‚
  - **ç»“æŸæµ**ï¼šä½¿ç”¨ `end()` æ–¹æ³•ç»“æŸå†™å…¥æ“ä½œã€‚
  - **é”€æ¯æµ**ï¼šä½¿ç”¨ `destroy()` æ–¹æ³•æ‰‹åŠ¨é”€æ¯æµã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
  - åŒå·¥æµçš„è¯»å–å’Œå†™å…¥æ“ä½œæ˜¯ç‹¬ç«‹çš„ï¼Œå› æ­¤éœ€è¦åˆ†åˆ«å®ç° `_read()` å’Œ `_write()` æ–¹æ³•ã€‚
  - åœ¨è‡ªå®šä¹‰åŒå·¥æµæ—¶ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†ç¼“å†²åŒºå’Œæµçš„çŠ¶æ€ï¼Œä»¥é¿å…å†…å­˜æ³„æ¼æˆ–æ•°æ®ä¸¢å¤±ã€‚

## 5. ğŸ“’ è½¬æ¢æµï¼ˆTransform Streamï¼‰

- è½¬æ¢æµæ˜¯ä¸€ç§ç‰¹æ®Šçš„åŒå·¥æµï¼Œå¯ä»¥åœ¨è¯»å–å’Œå†™å…¥è¿‡ç¨‹ä¸­å¯¹æ•°æ®è¿›è¡Œè½¬æ¢ã€‚
- ä¾‹å¦‚ï¼Œ`zlib.createGzip()` è¿”å›çš„å°±æ˜¯ä¸€ä¸ªè½¬æ¢æµï¼Œç”¨äºå‹ç¼©æ•°æ®ã€‚
- **è½¬æ¢æµçš„å®šä¹‰**ï¼š
  - è½¬æ¢æµæ˜¯ä¸€ç§ç‰¹æ®Šçš„åŒå·¥æµï¼Œç»§æ‰¿è‡ª `stream.Transform` ç±»ã€‚
  - å®ƒåœ¨è¯»å–å’Œå†™å…¥è¿‡ç¨‹ä¸­å¯¹æ•°æ®è¿›è¡Œè½¬æ¢ï¼Œé€‚ç”¨äºéœ€è¦å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥æˆ–å¤„ç†çš„åœºæ™¯ã€‚
- **è½¬æ¢æµçš„ç‰¹ç‚¹**ï¼š
  - **æ•°æ®è½¬æ¢**ï¼šè½¬æ¢æµçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥æˆ–è½¬æ¢ï¼Œä¾‹å¦‚å‹ç¼©ã€è§£å‹ã€åŠ å¯†ã€è§£å¯†ç­‰ã€‚
  - **é“¾å¼æ“ä½œ**ï¼šè½¬æ¢æµå¯ä»¥ä¸å…¶ä»–æµï¼ˆå¦‚å¯è¯»æµã€å¯å†™æµï¼‰ç»„åˆä½¿ç”¨ï¼Œå½¢æˆæ•°æ®å¤„ç†ç®¡é“ã€‚
- **è½¬æ¢æµçš„åº”ç”¨åœºæ™¯**ï¼š
  - **æ•°æ®å‹ç¼©ä¸è§£å‹**ï¼šä¾‹å¦‚ï¼Œä½¿ç”¨ `zlib.createGzip()` åˆ›å»ºä¸€ä¸ªå‹ç¼©æµï¼Œæˆ–è€…ä½¿ç”¨ `zlib.createGunzip()` åˆ›å»ºä¸€ä¸ªè§£å‹ç¼©æµã€‚
  - **æ•°æ®åŠ å¯†ä¸è§£å¯†**ï¼šä¾‹å¦‚ï¼Œä½¿ç”¨ `crypto.createCipher()` å’Œ `crypto.createDecipher()` å®ç°æ•°æ®åŠ å¯†å’Œè§£å¯†ã€‚
  - **æ•°æ®æ ¼å¼è½¬æ¢**ï¼šä¾‹å¦‚ï¼Œå°† JSON æ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œæˆ–å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸º Base64 ç¼–ç ã€‚
- **è½¬æ¢æµçš„åˆ›å»º**ï¼š
  - å¯ä»¥é€šè¿‡ç»§æ‰¿ `stream.Transform` ç±»æ¥åˆ›å»ºè‡ªå®šä¹‰çš„è½¬æ¢æµã€‚

```javascript
const { Transform } = require('stream')

class UppercaseTransform extends Transform {
  constructor(options) {
    super(options)
  }

  _transform(chunk, encoding, callback) {
    // å°†æ•°æ®è½¬æ¢ä¸ºå¤§å†™
    const uppercased = chunk.toString().toUpperCase()
    this.push(uppercased) // å°†è½¬æ¢åçš„æ•°æ®æ¨é€åˆ°å¯è¯»æµ
    callback() // è½¬æ¢å®Œæˆåçš„å›è°ƒ
  }
}

const transformStream = new UppercaseTransform()

// å†™å…¥æ•°æ®
transformStream.write('hello')
transformStream.write('world')

// ç»“æŸå†™å…¥
transformStream.end()

// è¯»å–æ•°æ®
transformStream.on('data', (chunk) => {
  console.log(`Transformed: ${chunk.toString()}`) // è¾“å‡º "HELLO" å’Œ "WORLD"
})
```

- **è½¬æ¢æµçš„å¸¸è§æ“ä½œ**ï¼š
  - **å†™å…¥æ•°æ®**ï¼šä½¿ç”¨ `write()` æ–¹æ³•å‘è½¬æ¢æµå†™å…¥æ•°æ®ã€‚
  - **è¯»å–æ•°æ®**ï¼šç›‘å¬ `data` äº‹ä»¶æˆ–è°ƒç”¨ `read()` æ–¹æ³•è¯»å–è½¬æ¢åçš„æ•°æ®ã€‚
  - **ç»“æŸæµ**ï¼šä½¿ç”¨ `end()` æ–¹æ³•ç»“æŸå†™å…¥æ“ä½œã€‚
  - **é”€æ¯æµ**ï¼šä½¿ç”¨ `destroy()` æ–¹æ³•æ‰‹åŠ¨é”€æ¯æµã€‚
- **å†…ç½®çš„è½¬æ¢æµ**ï¼šNode.js æä¾›äº†ä¸€äº›å¸¸ç”¨çš„è½¬æ¢æµï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```javascript
// å‹ç¼©ä¸è§£å‹
const zlib = require('zlib')
const fs = require('fs')

// å‹ç¼©æ–‡ä»¶
const gzip = zlib.createGzip()
const input = fs.createReadStream('input.txt')
const output = fs.createWriteStream('output.txt.gz')

input.pipe(gzip).pipe(output)
```

```javascript
// åŠ å¯†ä¸è§£å¯†
const crypto = require('crypto')
const fs = require('fs')

// åŠ å¯†æ–‡ä»¶
const cipher = crypto.createCipher('aes-256-cbc', 'secret-key')
const input = fs.createReadStream('input.txt')
const output = fs.createWriteStream('encrypted.txt')

input.pipe(cipher).pipe(output)
```

- **æ³¨æ„äº‹é¡¹**ï¼š
  - è½¬æ¢æµçš„æ ¸å¿ƒæ–¹æ³•æ˜¯ `_transform()`ï¼Œå®ƒè´Ÿè´£å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥æˆ–è½¬æ¢ã€‚
  - å¦‚æœéœ€è¦åœ¨æµç»“æŸæ—¶æ‰§è¡Œé¢å¤–çš„æ“ä½œï¼Œå¯ä»¥å®ç° `_flush()` æ–¹æ³•ã€‚
  - åœ¨è‡ªå®šä¹‰è½¬æ¢æµæ—¶ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†æ•°æ®å—å’Œç¼–ç ï¼Œä»¥é¿å…æ•°æ®æŸåæˆ–ä¸¢å¤±ã€‚
