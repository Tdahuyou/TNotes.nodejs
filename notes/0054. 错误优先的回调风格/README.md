# [0054. é”™è¯¯ä¼˜å…ˆçš„å›è°ƒé£æ ¼](https://github.com/tnotesjs/TNotes.nodejs/tree/main/notes/0054.%20%E9%94%99%E8%AF%AF%E4%BC%98%E5%85%88%E7%9A%84%E5%9B%9E%E8%B0%83%E9%A3%8E%E6%A0%BC)

<!-- region:toc -->

- [1. ğŸ“ æ¦‚è¿°](#1--æ¦‚è¿°)
- [2. ğŸ“’ é”™è¯¯å¤„ç†](#2--é”™è¯¯å¤„ç†)
- [3. ğŸ’» demos.1 - è¯»å–æ–‡ä»¶çš„é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼](#3--demos1---è¯»å–æ–‡ä»¶çš„é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼)
- [4. ğŸ’» demos.2 - è‡ªå®šä¹‰é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼å‡½æ•°](#4--demos2---è‡ªå®šä¹‰é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼å‡½æ•°)
- [5. ğŸ’» demos.3 - `util.promisify(original)` - è½¬æ¢å¼‚æ­¥å‡½æ•°çš„é£æ ¼](#5--demos3---utilpromisifyoriginal---è½¬æ¢å¼‚æ­¥å‡½æ•°çš„é£æ ¼)

<!-- endregion:toc -->

## 1. ğŸ“ æ¦‚è¿°

- **Error-First Callback Style**
  - **é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼ï¼ˆError-First Callback Styleï¼‰** æ˜¯ Node.js ä¸­ä¸€ç§å¸¸è§çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œç”¨äºå¤„ç†å¼‚æ­¥æ“ä½œçš„ç»“æœæˆ–é”™è¯¯ã€‚
  - åœ¨è¿™ç§é£æ ¼ä¸­ï¼Œå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å§‹ç»ˆæ˜¯é”™è¯¯å¯¹è±¡ï¼ˆ`err`ï¼‰ï¼Œåç»­çš„å‚æ•°æ‰æ˜¯æ“ä½œçš„ç»“æœæ•°æ®ã€‚
- **æ ¸å¿ƒç‰¹ç‚¹**ï¼šå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯å¯¹è±¡ï¼Œåç»­å‚æ•°æ˜¯æ“ä½œç»“æœã€‚
  1. **ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé”™è¯¯å¯¹è±¡**ï¼š
     - å¦‚æœæ“ä½œæˆåŠŸï¼Œé”™è¯¯å¯¹è±¡ä¸º `null` æˆ– `undefined`ã€‚
     - å¦‚æœæ“ä½œå¤±è´¥ï¼Œé”™è¯¯å¯¹è±¡åŒ…å«å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚
  2. **åç»­å‚æ•°ä¸ºç»“æœæ•°æ®**ï¼š
     - å¦‚æœæ“ä½œæˆåŠŸï¼Œç»“æœæ•°æ®ä¼šä½œä¸ºå›è°ƒå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆæˆ–æ›´å¤šå‚æ•°ï¼‰ä¼ é€’ã€‚
- **çº¦å®šä¿—æˆçš„è§„åˆ™**ï¼š
  - **é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼** æ˜¯ä¸€ç§çº¦å®šä¿—æˆçš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œé€‚ç”¨äº Node.js ç¯å¢ƒã€‚
    - è¿™ç§é£æ ¼åœ¨ Node.js çš„æ ¸å¿ƒæ¨¡å—ï¼ˆå¦‚ `fs`ã€`http` ç­‰ï¼‰å’Œè®¸å¤šç¬¬ä¸‰æ–¹åº“ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œå› æ­¤å®ƒæˆä¸ºäº†äº‹å®ä¸Šçš„æ ‡å‡†ï¼Œå¼€å‘è€…éœ€è¦éµå¾ªè¿™ç§çº¦å®šæ¥ç¼–å†™å…¼å®¹çš„ä»£ç ã€‚
  - **ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶**ï¼š
    - æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½éµå¾ªç›¸åŒçš„æ¨¡å¼ï¼Œä¾¿äºå¼€å‘è€…ç†è§£å’Œç»´æŠ¤ä»£ç ã€‚
  - **é¿å…é—æ¼é”™è¯¯å¤„ç†**ï¼š
    - å°†é”™è¯¯ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°å¼ºåˆ¶å¼€å‘è€…æ˜¾å¼å¤„ç†é”™è¯¯ï¼Œå‡å°‘äº†å¿½ç•¥é”™è¯¯çš„å¯èƒ½æ€§ã€‚
- **è½¬æ¢**ï¼š
  - å¦‚æœä½ éœ€è¦å°†è¿™ç§é£æ ¼çš„å‡½æ•°è½¬æ¢ä¸ºç°ä»£çš„ `Promise` é£æ ¼ï¼Œå¯ä»¥ä½¿ç”¨ `util.promisify` å·¥å…·å‡½æ•°ã€‚
  - å¦‚æœä½ éœ€è¦å°† **Promise** é£æ ¼çš„å‡½æ•°è½¬æ¢ä¸º **é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼**ï¼Œå¯ä»¥ä½¿ç”¨ `util.callbackify` å·¥å…·å‡½æ•°ã€‚

```mermaid
flowchart LR
    A[é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼å‡½æ•°] -->|util.promisify| B[Promise é£æ ¼å‡½æ•°]
    B -->|util.callbackify| A
```

## 2. ğŸ“’ é”™è¯¯å¤„ç†

- å›è°ƒå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ä¸º `error`
- å¼‚æ­¥æ–¹æ³•ï¼šé€šè¿‡å›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ•è·é”™è¯¯ï¼›
- åŒæ­¥æ–¹æ³•ï¼šéœ€ä½¿ç”¨ `try-catch` è¯­å¥æ•è·å¼‚å¸¸ï¼›

## 3. ğŸ’» demos.1 - è¯»å–æ–‡ä»¶çš„é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼

::: code-group

```javascript [1.cjs]
const fs = require('fs')
const path = require('path')

const filePath = path.join(__dirname, '1.txt')

// é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼
fs.readFile(
  filePath,
  'utf8',
  (
    err, // å›è°ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯å¯¹è±¡
    data // å›è°ƒçš„åç»­å‚æ•°æ‰æ˜¯ç»“æœæ•°æ®
  ) => {
    if (err) {
      console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', err)
      return
    }
    console.log('æ–‡ä»¶å†…å®¹ï¼š', data)
  }
)

// è¾“å‡ºï¼š
// é—®ä»·å†…å®¹ï¼štest

// Node.js çš„ fs.readFile æ–¹æ³•å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼çš„ä¾‹å­ã€‚

// å¦‚æœæ–‡ä»¶è¯»å–æˆåŠŸï¼š
// err ä¸º nullã€‚
// data åŒ…å«æ–‡ä»¶å†…å®¹ã€‚

// å¦‚æœæ–‡ä»¶è¯»å–å¤±è´¥ï¼š
// err åŒ…å«é”™è¯¯ä¿¡æ¯ã€‚
// data ä¸ä¼šè¢«ä¼ é€’ã€‚
```

```txt [1.txt]
test
```

:::

## 4. ğŸ’» demos.2 - è‡ªå®šä¹‰é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼å‡½æ•°

::: code-group

```javascript [1.cjs]
function divide(a, b, callback) {
  if (b === 0) {
    // æ“ä½œå¤±è´¥æ—¶ï¼Œä¼ é€’é”™è¯¯å¯¹è±¡
    return callback(new Error('é™¤æ•°ä¸èƒ½ä¸º 0'))
  }
  // æ“ä½œæˆåŠŸæ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º nullï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç»“æœ
  callback(null, a / b)
}

divide(10, 2, (err, result) => {
  if (err) {
    console.error('å‘ç”Ÿé”™è¯¯:', err.message)
    return
  }
  console.log('ç»“æœ:', result) // è¾“å‡º: ç»“æœ: 5
})

divide(10, 0, (err, result) => {
  if (err) {
    console.error('å‘ç”Ÿé”™è¯¯:', err.message) // è¾“å‡º: å‘ç”Ÿé”™è¯¯: é™¤æ•°ä¸èƒ½ä¸º 0
    return
  }
  console.log('ç»“æœ:', result)
})
```

:::

## 5. ğŸ’» demos.3 - `util.promisify(original)` - è½¬æ¢å¼‚æ­¥å‡½æ•°çš„é£æ ¼

::: code-group

```javascript [1.cjs]
const util = require('util')

function divide(a, b, callback) {
  if (b === 0) {
    // æ“ä½œå¤±è´¥æ—¶ï¼Œä¼ é€’é”™è¯¯å¯¹è±¡
    return callback(new Error('é™¤æ•°ä¸èƒ½ä¸º 0'))
  }
  // æ“ä½œæˆåŠŸæ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º nullï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç»“æœ
  callback(null, a / b)
}

divide(10, 2, (err, result) => {
  if (err) {
    console.error('å‘ç”Ÿé”™è¯¯:', err.message)
    return
  }
  console.log('ç»“æœ:', result) // è¾“å‡º: ç»“æœ: 5
})

divide(10, 0, (err, result) => {
  if (err) {
    console.error('å‘ç”Ÿé”™è¯¯:', err.message) // è¾“å‡º: å‘ç”Ÿé”™è¯¯: é™¤æ•°ä¸èƒ½ä¸º 0
    return
  }
  console.log('ç»“æœ:', result)
})

// ä¼ å…¥ä¸€ä¸ªéµå¾ªå¸¸è§çš„ é”™è¯¯ä¼˜å…ˆå›è°ƒé£æ ¼ çš„å‡½æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªè¿”å›å€¼ä¸º Promise çš„å‡½æ•°ã€‚
const dividePromise = util.promisify(divide)

dividePromise(10, 2)
  .then((result) => {
    console.log(result) // è¾“å‡ºï¼š5
  })
  .catch((error) => {
    console.error(error)
  })

dividePromise(10, 0)
  .then((result) => {
    console.log(result)
  })
  .catch((error) => {
    console.error(error) // è¾“å‡ºï¼šError: é™¤æ•°ä¸èƒ½ä¸º 0
  })

const divideErrorFirstCallback = util.callbackify(dividePromise)

divideErrorFirstCallback(10, 2, (err, result) => {
  if (err) {
    console.error('å‘ç”Ÿé”™è¯¯:', err.message)
    return
  }
  console.log('ç»“æœ:', result) // è¾“å‡º: ç»“æœ: 5
})

divideErrorFirstCallback(10, 0, (err, result) => {
  if (err) {
    console.error('å‘ç”Ÿé”™è¯¯:', err.message) // è¾“å‡º: å‘ç”Ÿé”™è¯¯: é™¤æ•°ä¸èƒ½ä¸º 0
    return
  }
  console.log('ç»“æœ:', result)
})
```

:::
