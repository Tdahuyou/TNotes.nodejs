# [0062. fs 中的 mode](https://github.com/Tdahuyou/TNotes.nodejs/tree/main/notes/0062.%20fs%20%E4%B8%AD%E7%9A%84%20mode)

<!-- region:toc -->

- [1. 📒 概述](#1--概述)
- [2. 📒 权限模型](#2--权限模型)
- [3. 📒 八进制表示法](#3--八进制表示法)
  - [3.1. 格式：](#31-格式)
  - [3.2. 示例：](#32-示例)
- [4. 📒 特殊权限位](#4--特殊权限位)
  - [4.1. 示例：](#41-示例)
- [5. 📒 `mode` 的使用场景](#5--mode-的使用场景)
  - [5.1. 创建文件时设置权限](#51-创建文件时设置权限)
  - [5.2. 创建目录时设置权限](#52-创建目录时设置权限)
  - [5.3. 修改现有文件或目录的权限](#53-修改现有文件或目录的权限)
- [6. 📒 默认权限](#6--默认权限)
  - [6.1. 示例：](#61-示例)
- [7. 📒 注意事项](#7--注意事项)

<!-- endregion:toc -->

## 1. 📒 概述

- **`fs` 模块中的 `mode` 参数**
  - 在 Node.js 的 `fs` 模块中，`mode` 是一个与文件权限相关的参数，用于指定文件或目录的访问权限。
  - 通过合理使用 `mode`，可以控制文件或目录的访问权限，确保程序的安全性和正确性。
  - 它通常以八进制数的形式表示（例如 `0o666` 或 `0o755`），遵循 Unix 文件权限模型。
  - 在实际开发中，需要注意跨平台差异以及系统 `umask` 的影响。
- **什么是 `mode`？**
  - **定义**：`mode` 是一个数字值，表示文件或目录的权限。
  - **用途**：
    - 在创建文件或目录时设置初始权限。
    - 修改现有文件或目录的权限（通过 `fs.chmod()`）。
  - **影响范围**：`mode` 参数主要用于类 Unix 系统（如 Linux 和 macOS）。在 Windows 上，某些权限可能不会生效或行为有所不同。

## 2. 📒 权限模型

Unix 文件权限分为三类用户组，每类用户组有三种权限：

| **用户组** | **符号表示** | **权限含义** |
| --- | --- | --- |
| **所有者 (Owner)** | `u` | 文件或目录的所有者的权限。 |
| **所属组 (Group)** | `g` | 文件或目录所属组的权限。 |
| **其他用户 (Others)** | `o` | 其他用户的权限（既不是所有者，也不属于所属组）。 |

每类用户组可以拥有以下三种权限：

| **权限** | **符号表示** | **八进制值** | **含义** |
| --- | --- | --- | --- |
| **读 (Read)** | `r` | `4` | 允许读取文件内容或列出目录内容。 |
| **写 (Write)** | `w` | `2` | 允许修改文件内容或添加/删除目录中的文件。 |
| **执行 (Execute)** | `x` | `1` | 对于文件：允许作为程序执行；对于目录：允许进入该目录并访问其子文件或子目录。 |

## 3. 📒 八进制表示法

`mode` 的值是一个八进制数，由三位或四位数字组成，每位数字表示一组权限的组合。

### 3.1. 格式：

```
[特殊权限位] [所有者权限] [所属组权限] [其他用户权限]
```

- 每个权限位的值是上述权限的八进制和（`r=4`, `w=2`, `x=1`）。
- 如果没有某个权限，则用 `0` 表示。

### 3.2. 示例：

- `0o666`：
  - 所有者、所属组和其他用户都有读写权限（`rw-rw-rw-`）。
- `0o755`：
  - 所有者有读、写和执行权限（`rwx`），所属组和其他用户只有读和执行权限（`r-x`）。
- `0o444`：
  - 所有用户都只有读权限（`r--r--r--`）。

## 4. 📒 特殊权限位

在某些情况下，`mode` 可能包含额外的特殊权限位（最高位），这些权限位会影响文件或目录的行为。

| **特殊权限位** | **八进制值** | **含义** |
| --- | --- | --- |
| **Set UID (SUID)** | `4` | 当文件被执行时，进程会以文件所有者的权限运行（而非当前用户的权限）。 |
| **Set GID (SGID)** | `2` | 类似 SUID，但适用于文件所属组。 |
| **Sticky Bit** | `1` | 仅对目录有效，限制只有文件所有者才能删除或重命名自己的文件（常用于 `/tmp`）。 |

### 4.1. 示例：

- `0o4755`：
  - 包含 SUID 位（`4`），所有者有 `rwx` 权限，所属组和其他用户有 `r-x` 权限。

## 5. 📒 `mode` 的使用场景

以下是 `mode` 在 `fs` 模块中的常见应用场景和方法：

### 5.1. 创建文件时设置权限

- 方法：`fs.writeFileSync()`、`fs.writeFile()`。
- 示例：
  ```javascript
  const fs = require('fs')
  fs.writeFileSync('demo.txt', 'Hello', { mode: 0o644 }) // 设置为 rw-r--r--
  ```

### 5.2. 创建目录时设置权限

- 方法：`fs.mkdirSync()`、`fs.mkdir()`。
- 示例：
  ```javascript
  const fs = require('fs')
  fs.mkdirSync('demoDir', { mode: 0o755 }) // 设置为 rwxr-xr-x
  ```

### 5.3. 修改现有文件或目录的权限

- 方法：`fs.chmodSync()`、`fs.chmod()`。
- 示例：
  ```javascript
  const fs = require('fs')
  fs.chmodSync('demo.txt', 0o444) // 修改为只读权限
  ```

## 6. 📒 默认权限

- 在 Node.js 中，如果未显式指定 `mode` 参数，文件或目录的默认权限通常是 `0o666`（文件）或 `0o777`（目录）。
- 实际生效的权限还会受到系统 `umask` 值的影响（`umask` 会屏蔽某些权限位）。

### 6.1. 示例：

假设系统的 `umask` 值为 `0o022`：

- 创建文件时，默认权限为 `0o666 & ~0o022 = 0o644`（`rw-r--r--`）。
- 创建目录时，默认权限为 `0o777 & ~0o022 = 0o755`（`rwxr-xr-x`）。

## 7. 📒 注意事项

1. **跨平台差异**：
   - `mode` 参数在类 Unix 系统（如 Linux 和 macOS）上效果显著，但在 Windows 上可能无效或行为不同。
   - 在 Windows 上，建议使用其他方式（如 ACL）管理文件权限。
2. **权限冲突**：
   - 如果文件或目录的权限与系统安全策略冲突，可能会导致操作失败。
3. **调试权限问题**：
   - 使用 `fs.stat()` 或 `fs.access()` 方法检查文件的实际权限。
